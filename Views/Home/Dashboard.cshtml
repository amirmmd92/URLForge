@model List<Distributed_URL_Shortener_with_Analytics.Models.ShortLink>
@{
    ViewData["Title"] = "Dashboard";
    var baseUrl = ViewBag.BaseUrl as string ?? "";
}

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title"><i class="bi bi-speedometer2"></i> My Links</h2>
                <p class="text-muted">Manage your shortened URLs and view analytics</p>
            </div>
        </div>

        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Short Code</th>
                            <th>Original URL</th>
                            <th>Created</th>
                            <th>Clicks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var link in Model)
                        {
                            <tr class="@(!link.IsActive ? "table-secondary opacity-50" : "")">
                                <td>
                                    @if (link.IsActive)
                                    {
                                        <a href="@baseUrl/r/@link.ShortCode" target="_blank" class="text-decoration-none">
                                            @baseUrl/r/@link.ShortCode
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted text-decoration-line-through">
                                            @baseUrl/r/@link.ShortCode
                                        </span>
                                        <span class="badge bg-secondary ms-2">Deleted</span>
                                    }
                                </td>
                                <td>
                                    @if (link.IsActive)
                                    {
                                        <a href="@link.OriginalUrl" target="_blank" class="text-decoration-none">
                                            @(link.OriginalUrl.Length > 50 ? link.OriginalUrl.Substring(0, 50) + "..." : link.OriginalUrl)
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted text-decoration-line-through">
                                            @(link.OriginalUrl.Length > 50 ? link.OriginalUrl.Substring(0, 50) + "..." : link.OriginalUrl)
                                        </span>
                                    }
                                </td>
                                <td>@link.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>
                                    @if (link.HasAnalytics)
                                    {
                                        <span class="badge bg-primary">@(link.ClickAnalytics?.Count ?? 0)</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">N/A</span>
                                    }
                                </td>
                                <td>
                                    @if (link.IsActive)
                                    {
                                        @if (link.HasAnalytics)
                                        {
                                            <a href="/Home/Analytics/@link.Id" class="btn btn-sm btn-info">
                                                <i class="bi bi-graph-up"></i> Analytics
                                            </a>
                                        }
                                        <button class="btn btn-sm btn-danger" onclick="deleteLink(@link.Id)">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">Link deleted</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">No links created yet. Start by creating a short link!</p>
                    <a href="/" class="btn btn-primary">Create Short Link</a>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function deleteLink(linkId) {
            if (!confirm('Are you sure you want to delete this link?')) {
                return;
            }
            
            // Get anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            
            fetch('/Home/DeleteLink', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token || ''
                },
                body: new URLSearchParams({ 
                    id: linkId,
                    __RequestVerificationToken: token || ''
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to delete link: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the link');
            });
        }
    </script>
}

